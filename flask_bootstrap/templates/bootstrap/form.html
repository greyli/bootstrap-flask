{#  This file was part of Flask-Bootstrap and was modified under the terms of
    its BSD License. Copyright (c) 2013, Marc Brinkmann. All rights reserved. #}
{%- from 'bootstrap/utils.html' import typename, modulename, class, get_col_from_count, get_col, tag -%}


{%- macro css_horizontal_fix() -%}
{%- block css_horizontal_fix scoped -%}
    <style>
        /* A fix for custom checkboxes and custom files in horizontal rows */
        form .form-row > [class*="col-"].custom-control .custom-control-label::before,
        form .form-row > [class*="col-"].custom-control .custom-control-label::after,
        form .form-row > [class*="col-"].custom-file .custom-file-label {
            margin-left: 5px;
            margin-right: 5px;
        }
        form .row > [class*="col-"].custom-control .custom-control-label::before,
        form .row > [class*="col-"].custom-control .custom-control-label::after,
        form .row > [class*="col-"].custom-file .custom-file-label {
            margin-left: 15px;
            margin-right: 15px;
        }
        form .custom-control {
            padding-left: 0px;
        }
        form .row > [class*="col-"].custom-control {
            padding-left: 15px;
        }
        form .custom-control .custom-control-label {
            margin-left: 1.5rem;
        }
    </style>
{%- endblock -%}
{%- endmacro -%}


{%- macro hidden_errors(field) -%}
{%- block hidden_errors scoped -%}
    {# Doesn't actually work, has no element which makes it "display: block" #}
    {%- for subfield in field|select('is_hidden') -%}
        {{ error(subfield) }}
    {%- endfor -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro input_container(container_type=none, opts={}) -%}{%- set outer_caller = caller -%}
{%- block input_container scoped -%}
    {%- call tag("div", container_type, get_col(12 - opts.horizontal_label_width, opts.col_type) if opts.horizontal) -%}
        {{ outer_caller() }}
    {%- endcall -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro group(type, col=none, extra=none, opts={}) -%}{%- set outer_caller = caller -%}{%- set outer_kwargs = kwargs -%}
{%- block group scoped -%}
    {%- call tag(type, col, 'mb-2 mr-sm-2' if opts.inline and not col, ('form-row' if opts.compact_tables else 'row') if opts.horizontal, extra, **outer_kwargs) -%}
        {{ outer_caller() }}
    {%- endcall -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro help(field, opts={}) -%}
{%- block help scoped -%}
    {%- if field.description -%}
        <small id="{{ '%s-desc' % field.id }}" class="{{ class('text-muted', 'form-text' if not opts.inline)  }}">{{ field.description }}</small>
    {%- endif -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro error(field, opts={}) -%}
{%- block error scoped -%}
    {%- for error in field.errors -%}
        <span class="invalid-{{ 'tooltip' if opts.tooltips else 'feedback' }}">{{ error }}</span>
    {%- endfor -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro label(field, is_before=true, legend=false, label_class=none, hide_label=false, opts={}) -%}
{%- block label scoped -%}
    {%- set label_class = class(label_class, 'sr-only' if hide_label) -%}
    {%- set outer_class = class('col-form-label', get_col(opts.horizontal_label_width, opts.col_type)) if opts.horizontal -%}
    {%- if legend -%}
        {%- call tag("div", outer_class) -%}
            <legend class="{{ label_class }}" for="{{ field.label.field_id }}">{{ field.label.text }}</legend>
        {%- endcall -%}
    {%- else -%}
        {{ field.label(class=class(label_class, outer_class if is_before)) }}
    {%- endif -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro render(field, field_class=none, hide_label=false, opts={}) -%}
{%- block render scoped -%}
    {%- set render_kw = dict() -%}
    {%- set _ = render_kw.setdefault("placeholder", field.label.text) if hide_label -%}
    {%- set _ = render_kw.setdefault("aria-describedby",'%s-desc' % field.id) if field.description -%}
    {{ field(class=class(field_class|default("form-control", true), "is-invalid" if field.errors), **render_kw) }}
{%- endblock -%}
{%- endmacro -%}


{%- macro render_single(field, hide_label=false, col=none, prefix_label=true, container_type=none, field_class=none, label_class=none, double_label=false, opts={}) -%}
{%- block render_single scoped -%}
    {%- call group("div", col, "form-group", opts=opts) -%}
        {{ label(field, is_before=true, label_class=(("d-%s-inline-block d-none" % opts.col_type if opts.col_type else "d-inline-block") if double_label else label_class), hide_label=hide_label, opts=opts) if prefix_label or double_label }}
        {%- call input_container(container_type=container_type, opts=opts) -%}
            {{ render(field, field_class=field_class, hide_label=hide_label, opts=opts) }}
            {{ label(field, is_before=false, label_class=label_class, hide_label=hide_label, opts=opts) if not prefix_label or double_label }}
            {{ help(field, opts=opts) }}
            {{ error(field, opts=opts) if not opts.inline }}
        {%- endcall -%}
    {%- endcall -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro render_nested(field, hide_label=false, container_type=none, opts={}) -%}{%- set outer_kwargs = kwargs -%}
{%- block render_nested scoped -%}
    {%- call group("fieldset", opts=opts, id=field.id) -%}
        {{ label(field, legend=true, hide_label=hide_label, opts=opts) }}
        {{ hidden_errors(field) }}
        {%- call input_container(container_type=container_type, opts=opts) -%}
            {%- for subfield in field -%}
                {{ render_field(subfield, in_block=true, opts=opts, **outer_kwargs) }}
            {%- endfor -%}
        {%- endcall -%}
    {%- endcall -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro render_field(field, in_block=false, col=none, prefix_label=true, opts=opts) -%}
{%- block render_field scoped -%}
    {%- set widget_type = typename(field.widget) -%}
    {%- set widget_module = modulename(field.widget) -%}
    {%- set opts.horizontal = opts.horizontal and not in_block -%}
    {%- set prefix_label = prefix_label or opts.horizontal -%}
    {%- set hide_label = in_block or opts.inline -%}

    {%- if widget_module == 'wtforms.widgets.html5' -%}
        {%- if widget_type == "RangeInput" -%}
            {%- set field_class = "custom-range" if opts.custom else "form-control-range" -%}
        {%- endif -%}
        {{ render_single(field, hide_label=hide_label, col=col, prefix_label=prefix_label, field_class=field_class, opts=opts) }}

    {%- elif widget_module == 'wtforms.widgets.core' -%}
        {%- if widget_type in ('Option', 'HiddenInput') -%}
            {{ field() }} {# `Option` is a pseudowidget, we don't wanna to do anything fancy here #}

        {%- elif widget_type == 'FileInput' -%}
            {{ render_single(
                field,
                hide_label=hide_label and not opts.custom,
                col=col,
                prefix_label=prefix_label and not opts.custom,
                container_type="custom-file" if opts.custom,
                field_class="custom-file-input" if opts.custom else "form-control-file",
                label_class="custom-file-label" if opts.custom,
                double_label=opts.horizontal and opts.custom,
                opts=opts,
            ) }}

        {%- elif widget_type in ("CheckboxInput", "RadioInput") -%}
            {{ render_single(
                field,
                hide_label=false,
                col=col,
                prefix_label=prefix_label and opts.horizontal,
                container_type=class("custom-control", "custom-checkbox" if widget_type == "CheckboxInput" else "custom-radio", "custom-control-inline" if opts.inline) if opts.custom else class("form-check", "form-check-inline" if opts.inline),
                field_class="custom-control-input" if opts.custom else "form-check-input",
                label_class="custom-control-label" if opts.custom else "form-check-label",
                double_label=opts.horizontal and opts.custom,
                opts=opts,
            ) }}

        {%- elif widget_type == 'Select' -%}
            {{ render_single(field, hide_label=hide_label, col=col, prefix_label=prefix_label, field_class="custom-select" if opts.custom, opts=opts) }}

        {%- elif widget_type == 'SubmitInput' -%}
            {{ render_single(field, hide_label=true, col=col, prefix_label=prefix_label, field_class="btn btn-primary", opts=opts) }}

        {%- elif widget_type == 'ListWidget' -%}
            {# Removes support for actual list elements like `ul` & `li` #}
            {{ render_nested(field, hide_label=hide_label, opts=opts, col=col, prefix_label=field.widget.prefix_label) }}

        {%- elif widget_type == 'TableWidget' -%}
            {{ render_nested(field, hide_label=hide_label, container_type=('form-row' if opts.compact_tables else 'row'), opts=opts, col=get_col_from_count(field|reject('is_hidden')|list|length, opts.col_type)) }}

        {%- else -%}
            {{ render_single(field, hide_label=hide_label, col=col, prefix_label=prefix_label, opts=opts) }}
        {%- endif -%}

    {%- else -%}
        {%- block render_field_unknown scoped -%}
            {# We can try to render the unknown element, but this block is intended to be extended #}
            {{ render_single(field, hide_label=hide_label, col=col, prefix_label=prefix_label, opts=opts) }}
        {%- endblock -%}
    {%- endif -%}
{%- endblock -%}
{%- endmacro -%}


{%- macro render_form(form, inline=false, tooltips=false, custom=false, col_type="md", compact_tables=false, horizontal=false, horizontal_label_width=3) -%}{% set outer_kwargs = kwargs %}
{%- block render_form scoped -%}
    {# `col_type` should be one of [none, "sm", "md", "lg", "xl"] #}
    {# `horizontal_label_width` should be a number between 1 and 11, that specifies the label width if the form is horizontal #}
    {%- set _ = outer_kwargs.setdefault("method", "post") -%}
    {%- set _ = outer_kwargs.setdefault("action", "") -%}
    {%- set _ = outer_kwargs.setdefault("enctype", "multipart/form-data") if form|selectattr("type", "equalto", "FileField") -%}
    {%- call tag("form", 'form-inline' if inline, **outer_kwargs) -%}
        {{ css_horizontal_fix() }}
        {{ hidden_errors(field) }}
        {%- for field in form -%}
            {{ render_field(field, opts=namespace(inline=inline, tooltips=tooltips, custom=custom, col_type=col_type, compact_tables=compact_tables, horizontal=horizontal, horizontal_label_width=horizontal_label_width)) }}
        {%- endfor -%}
    {%- endcall -%}
{%- endblock -%}
{%- endmacro -%}
